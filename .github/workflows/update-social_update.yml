name: Update Social Media Data

on:
  schedule:
    - cron: '0 0 * * *'  # æ¯æ—¥0æ™‚ã«å®Ÿè¡Œ
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

jobs:
  update-social-data:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install dependencies
      run: |
        npm init -y
        npm install axios
        
    - name: Create and run Twitter data fetch script
      env:
        TWITTER_BEARER_TOKEN: ${{ secrets.TWITTER_BEARER_TOKEN }}
        TWITTER_USER_ID: ${{ secrets.TWITTER_USER_ID }}
      run: |
        cat > fetch-twitter.js << 'EOF'
        const axios = require('axios');
        const fs = require('fs');
        const path = require('path');
        
        // ç’°å¢ƒå¤‰æ•°ã‹ã‚‰èªè¨¼æƒ…å ±ã‚’å–å¾—
        const BEARER_TOKEN = process.env.TWITTER_BEARER_TOKEN;
        const USER_ID = process.env.TWITTER_USER_ID;
        
        console.log('Environment check:');
        console.log('BEARER_TOKEN:', BEARER_TOKEN ? 'Set (length: ' + BEARER_TOKEN.length + ')' : 'Not set');
        console.log('USER_ID:', USER_ID || 'Not set');
        
        if (!BEARER_TOKEN || !USER_ID) {
            console.error('å¿…è¦ãªç’°å¢ƒå¤‰æ•°ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
            process.exit(1);
        }
        
        const headers = {
            'Authorization': `Bearer ${BEARER_TOKEN}`,
            'Content-Type': 'application/json',
        };
        
        async function fetchWithRetry(url, options, maxRetries = 3) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await axios.get(url, options);
                    return response;
                } catch (error) {
                    console.log(`Attempt ${i + 1} failed:`, error.response?.status, error.response?.statusText);
                    if (i === maxRetries - 1) throw error;
                    
                    console.log(`Retrying in ${(i + 1) * 2} seconds...`);
                    await new Promise(resolve => setTimeout(resolve, (i + 1) * 2000));
                }
            }
        }
        
        async function fetchUserInfo() {
            try {
                console.log('Fetching user info...');
                const response = await fetchWithRetry(
                    `https://api.twitter.com/2/users/${USER_ID}?user.fields=public_metrics`,
                    { headers }
                );
                
                console.log('API Response status:', response.status);
                const user = response.data.data;
                console.log('User info fetched successfully:', user.username);
                
                return {
                    name: user.name,
                    username: user.username,
                    followers_count: user.public_metrics.followers_count,
                    following_count: user.public_metrics.following_count,
                    tweet_count: user.public_metrics.tweet_count
                };
            } catch (error) {
                console.error('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼:');
                console.error('Status:', error.response?.status);
                console.error('Data:', JSON.stringify(error.response?.data, null, 2));
                throw error;
            }
        }
        
        async function main() {
            try {
                console.log('=== Twitter ãƒ‡ãƒ¼ã‚¿å–å¾—é–‹å§‹ ===');
                console.log('Timestamp:', new Date().toISOString());
                
                const userInfo = await fetchUserInfo();
                
                const data = {
                    lastUpdated: new Date().toISOString(),
                    user: userInfo
                };
                
                // ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½œæˆ
                const outputPath = 'site_data/json/twitter_data.json';
                const outputDir = path.dirname(outputPath);
                
                console.log('Creating output directory:', outputDir);
                if (!fs.existsSync(outputDir)) {
                    fs.mkdirSync(outputDir, { recursive: true });
                }
                
                // JSONãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
                console.log('Writing to:', outputPath);
                fs.writeFileSync(
                    outputPath,
                    JSON.stringify(data, null, 2),
                    'utf8'
                );
                
                console.log('=== Twitter ãƒ‡ãƒ¼ã‚¿æ›´æ–°å®Œäº† ===');
                console.log(`ãƒ¦ãƒ¼ã‚¶ãƒ¼: @${userInfo.username} (${userInfo.name})`);
                console.log(`ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼æ•°: ${userInfo.followers_count.toLocaleString()}`);
                console.log(`ãƒ•ã‚©ãƒ­ãƒ¼æ•°: ${userInfo.following_count.toLocaleString()}`);
                console.log(`ç·ãƒ„ã‚¤ãƒ¼ãƒˆæ•°: ${userInfo.tweet_count.toLocaleString()}`);
                
                // ãƒ•ã‚¡ã‚¤ãƒ«ãŒæ­£å¸¸ã«ä½œæˆã•ã‚ŒãŸã‹ç¢ºèª
                if (fs.existsSync(outputPath)) {
                    const fileSize = fs.statSync(outputPath).size;
                    console.log(`ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: ${fileSize} bytes`);
                } else {
                    throw new Error('JSONãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
                
            } catch (error) {
                console.error('=== ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ ===');
                console.error('Error:', error.message);
                console.error('Stack:', error.stack);
                process.exit(1);
            }
        }
        
        main();
        EOF
        
        echo "Running Twitter data fetch..."
        node fetch-twitter.js
        
    - name: Fetch YouTube Data
      env:
        YOUTUBE_API_KEY: ${{ secrets.YOUTUBE_API_KEY }}
        CHANNEL_ID: ${{ secrets.CHANNEL_ID }}
      run: |
        echo "=== YouTube ãƒ‡ãƒ¼ã‚¿å–å¾—é–‹å§‹ ==="
        
        # YouTubeã®æœ€æ–°å‹•ç”»ã‚’å–å¾—
        SEARCH_RESPONSE=$(curl -s "https://www.googleapis.com/youtube/v3/search?key=${YOUTUBE_API_KEY}&channelId=${CHANNEL_ID}&part=snippet&order=date&maxResults=3&type=video")
        
        if [ $? -ne 0 ]; then
          echo "YouTubeæ¤œç´¢APIã®å‘¼ã³å‡ºã—ã«å¤±æ•—ã—ã¾ã—ãŸ"
          exit 1
        fi
        
        # å‹•ç”»IDã‚’æŠ½å‡º
        VIDEO_IDS=$(echo "$SEARCH_RESPONSE" | jq -r '.items[].id.videoId' | tr '\n' ',' | sed 's/,$//')
        
        if [ -z "$VIDEO_IDS" ]; then
          echo "å‹•ç”»IDã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ"
          exit 1
        fi
        
        echo "å–å¾—ã—ãŸå‹•ç”»ID: $VIDEO_IDS"
        
        # å†ç”Ÿæ•°ãªã©ã®çµ±è¨ˆæƒ…å ±ã‚’å–å¾—
        STATS_RESPONSE=$(curl -s "https://www.googleapis.com/youtube/v3/videos?key=${YOUTUBE_API_KEY}&id=${VIDEO_IDS}&part=statistics,snippet")
        
        if [ $? -ne 0 ]; then
          echo "YouTubeçµ±è¨ˆAPIã®å‘¼ã³å‡ºã—ã«å¤±æ•—ã—ã¾ã—ãŸ"
          exit 1
        fi
        
        # ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
        mkdir -p site_data/json
        
        # JSONãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ä¿å­˜
        echo "$STATS_RESPONSE" > site_data/json/youtube_data.json
        
        echo "=== YouTube ãƒ‡ãƒ¼ã‚¿æ›´æ–°å®Œäº† ==="
        
    - name: Create YouTube data formatter script
      run: |
        cat > youtube-data.js << 'EOF'
        const fs = require('fs');
        const path = require('path');
        
        try {
            console.log('=== YouTube ãƒ‡ãƒ¼ã‚¿æ•´å½¢é–‹å§‹ ===');
            
            const inputPath = 'site_data/json/youtube_data.json';
            const outputPath = 'site_data/json/youtube_formatted.json';
            
            if (!fs.existsSync(inputPath)) {
                throw new Error('YouTube ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            }
            
            const rawData = JSON.parse(fs.readFileSync(inputPath, 'utf8'));
            
            const formattedData = {
                lastUpdated: new Date().toISOString(),
                videos: rawData.items ? rawData.items.map(item => ({
                    id: item.id,
                    title: item.snippet.title,
                    description: item.snippet.description.substring(0, 200) + '...',
                    publishedAt: item.snippet.publishedAt,
                    thumbnail: item.snippet.thumbnails.medium.url,
                    statistics: {
                        viewCount: parseInt(item.statistics.viewCount || '0'),
                        likeCount: parseInt(item.statistics.likeCount || '0'),
                        commentCount: parseInt(item.statistics.commentCount || '0')
                    }
                })) : []
            };
            
            fs.writeFileSync(outputPath, JSON.stringify(formattedData, null, 2), 'utf8');
            
            console.log(`æ•´å½¢æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜: ${outputPath}`);
            console.log(`å‹•ç”»æ•°: ${formattedData.videos.length}`);
            
            // å…ƒã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ã—ã¦æ•´å½¢æ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒªãƒãƒ¼ãƒ 
            fs.unlinkSync(inputPath);
            fs.renameSync(outputPath, inputPath);
            
            console.log('=== YouTube ãƒ‡ãƒ¼ã‚¿æ•´å½¢å®Œäº† ===');
            
        } catch (error) {
            console.error('YouTube ãƒ‡ãƒ¼ã‚¿æ•´å½¢ã‚¨ãƒ©ãƒ¼:', error.message);
            process.exit(1);
        }
        EOF
        
    - name: Format YouTube data
      run: |
        echo "Running YouTube data formatter..."
        node youtube-data.js
        
    - name: Check generated files
      run: |
        echo "=== ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª ==="
        
        if [ -f "site_data/json/twitter_data.json" ]; then
          echo "âœ… Twitter ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ã¾ã™"
          echo "ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: $(stat -c%s site_data/json/twitter_data.json) bytes"
        else
          echo "âŒ Twitter ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
        fi
        
        if [ -f "site_data/json/youtube_data.json" ]; then
          echo "âœ… YouTube ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ã¾ã™"
          echo "ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: $(stat -c%s site_data/json/youtube_data.json) bytes"
        else
          echo "âŒ YouTube ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
        fi
        
        echo -e "\nç”Ÿæˆã•ã‚ŒãŸJSONãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§:"
        find site_data -name "*.json" -type f -exec ls -la {} \;
        
    - name: Check for data changes
      id: check_changes
      run: |
        # æ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ã¨æ¯”è¼ƒã™ã‚‹ãŸã‚ã€ä¸€æ™‚çš„ã«gh-pagesãƒ–ãƒ©ãƒ³ãƒã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        git fetch origin gh-pages:gh-pages 2>/dev/null || echo "gh-pages branch not found, first run"
        
        # å¤‰æ›´ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        CHANGES_DETECTED=false
        
        if git show gh-pages:site_data/json/twitter_data.json 2>/dev/null > /tmp/old_twitter.json; then
          # ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼æ•°ãªã©ã€æ„å‘³ã®ã‚ã‚‹å¤‰æ›´ã®ã¿ãƒã‚§ãƒƒã‚¯
          OLD_FOLLOWERS=$(cat /tmp/old_twitter.json | jq -r '.user.followers_count // 0')
          NEW_FOLLOWERS=$(cat site_data/json/twitter_data.json | jq -r '.user.followers_count // 0')
          
          # ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼æ•°ãŒ10ä»¥ä¸Šå¤‰åŒ–ã—ãŸå ´åˆã®ã¿æ›´æ–°
          FOLLOWER_DIFF=$((NEW_FOLLOWERS - OLD_FOLLOWERS))
          if [ ${FOLLOWER_DIFF#-} -ge 10 ]; then
            echo "Twitter followers changed significantly: $OLD_FOLLOWERS -> $NEW_FOLLOWERS"
            CHANGES_DETECTED=true
          fi
        else
          echo "No existing Twitter data found, will update"
          CHANGES_DETECTED=true
        fi
        
        if git show gh-pages:site_data/json/youtube_data.json 2>/dev/null > /tmp/old_youtube.json; then
          # æ–°ã—ã„å‹•ç”»ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          OLD_VIDEO_COUNT=$(cat /tmp/old_youtube.json | jq -r '.videos | length')
          NEW_VIDEO_COUNT=$(cat site_data/json/youtube_data.json | jq -r '.videos | length')
          
          # æœ€æ–°å‹•ç”»ã®IDã‚’ãƒã‚§ãƒƒã‚¯
          OLD_LATEST_ID=$(cat /tmp/old_youtube.json | jq -r '.videos[0].id // ""')
          NEW_LATEST_ID=$(cat site_data/json/youtube_data.json | jq -r '.videos[0].id // ""')
          
          if [ "$OLD_LATEST_ID" != "$NEW_LATEST_ID" ] || [ "$OLD_VIDEO_COUNT" != "$NEW_VIDEO_COUNT" ]; then
            echo "YouTube content changed: new video or count changed"
            CHANGES_DETECTED=true
          fi
        else
          echo "No existing YouTube data found, will update"
          CHANGES_DETECTED=true
        fi
        
        echo "changes_detected=$CHANGES_DETECTED" >> $GITHUB_OUTPUT
        
    - name: Deploy to gh-pages branch (only if changes detected)
      if: steps.check_changes.outputs.changes_detected == 'true'
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./site_data
        publish_branch: gh-pages
        destination_dir: .
        force_orphan: false
        commit_message: "ğŸ“Š Update social media data"
        
    - name: Skip deployment message
      if: steps.check_changes.outputs.changes_detected == 'false'
      run: |
        echo "â­ï¸ No significant changes detected, skipping deployment"